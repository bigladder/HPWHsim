<!doctype html>

<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>HPWH analysis</title>

<style>
body {font-family: Arial;}

.collapsible {
  background-color: #777;
  color: white;
  cursor: pointer;
  padding: 18px;
  width: 100%;
  border: none;
  text-align: left;
  outline: none;
  font-size: 15px;
}

.active, .collapsible:hover {
  background-color: #555;
}

.content {
  padding: 0 18px;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.2s ease-out;
  background-color: #f1f1f1;
}
</style>

</head>

<body>

<form id="model_form">
    <label for="model_name">model name:</label>
		<select name="model_name" id="model_name" style="width: 400px" > 
 		</select><br><br>

    <label for="model_spec">model spec:</label>
	  <select name="model_spec" id="model_spec">    
	    <option selected="selected" value="File">File</option>
			<option value="Preset">Preset</option>
			<option value="JSON">JSON</option>
	  </select><br><br>
</form>

<form id="build_form">
    <label for="build_dir">build directory:</label>
    <input type="text" id="build_dir" name="build_dir" style="width: 400px" required><br><br>
</form>

<script>
	async function get_json(filename) {
    fst = 'filename=' +  filename;
	  const response = await fetch('http://localhost:8000/read_json?' + fst,
		{
			method: 'GET'
		}
	  );
		json_data = await response.json();
		return json_data
	}

	async function get_models() {
		model_list = await get_json('./model_index.json')
		let select = document.querySelector("#model_name")
		for (let model of model_list["models"]){
		  let option = document.createElement("option");
		  option.text = model["name"];
		  option.value = model["name"];
		  select.appendChild(option);
		}
		return model_list
	}

	var pref_model_name = "BradfordWhiteAeroThermRE2H65"
	var pref_model_spec = "File"

	async function get_prefs() {
		prefs_list = await get_json('./prefs.json')
		if ("model_name" in prefs_list)
		{
			pref_model_name = prefs_list["model_name"]
		}
		if ("model_spec" in prefs_list)
		{
			pref_model_spec= prefs_list["model_spec"]
		}
		return prefs_list
	}

	async function fill_prefs()
	{
		model_list = await get_models()
		prefs_list = await get_prefs()
	  const model_form = document.getElementById('model_form');
	  model_form.model_name.value = pref_model_name;
	  model_form.model_spec.value = pref_model_spec

	  const build_form = document.getElementById('build_form');
	  build_form.build_dir.value = "../../../build";
	}
</script>

<script>
  async function test() {

    const build_form = document.getElementById('build_form');
    const build_dir = build_form.build_dir.value;

    const model_form = document.getElementById('model_form');
    const model_spec = model_form.model_spec.value;
    const model_name = model_form.model_name.value;

    const test_form = document.getElementById('test_form');
    const test_dir = test_form.test_dir.value;

    fst = 'model_spec=' +  model_spec;
    fst += '&model_name=' + model_name;
    fst += '&test_dir=' + test_dir;
    fst += '&build_dir=' + build_dir;
    document.getElementById("test_btn").disabled = true;

	  const response = await fetch('http://localhost:8000/test?' + fst,
		{
			method: 'GET'
		}
	  );

    const test_results = await response.json();
    const energy_data = test_results["energy_data"];
		const dash_port = test_results["port_num"];

    measE = energy_data["measuredE_Wh"].toFixed(2);
    simE = energy_data["simulatedE_Wh"].toFixed(2);
    document.getElementById("energy_measured").innerHTML = "Measured energy consumption (Wh): " + measE;
    document.getElementById("energy_simulated").innerHTML = "Simulated energy consumption (Wh): " + simE;

    model_form.model_spec.value = model_spec;
    model_form.model_name.value = model_name;

    document.getElementById("model_spec").value = model_spec; 
    document.getElementById("model_name").value = model_name;
    document.getElementById("test_dir").value = test_dir; 
    document.getElementById("build_dir").value = build_dir; 

    document.getElementById("model_spec").defaultValue = model_spec; 
    document.getElementById("model_name").defaultValue = model_name; 
    document.getElementById("test_dir").defaultValue = test_dir; 
    document.getElementById("build_dir").defaultValue = build_dir; 
 
    localStorage.setItem("model_spec", model_spec);
    localStorage.setItem("model_name", model_name);
    localStorage.setItem("test_dir", test_dir);
    localStorage.setItem("build_dir", build_dir);

		const port_string = "http://localhost:" + dash_port
    document.getElementById("plots").src = port_string
    document.getElementById("plots").style = "display:block;"
  
    document.getElementById("test_btn").disabled = false;
  }

  async function measure() {
    const build_form = document.getElementById('build_form');
    const build_dir = build_form.build_dir.value;

    const model_form = document.getElementById('model_form');
    const model_spec = model_form.model_spec.value;
    const model_name = model_form.model_name.value;

		const measure_form = document.getElementById('measure_form');
    const draw_profile = measure_form.draw_profile.value;

    fst = 'model_spec=' +  model_spec;
    fst += '&model_name=' + model_name;
    fst += '&build_dir=' + build_dir;
    fst += '&draw_profile=' + draw_profile;

    document.getElementById("measure_btn").disabled = true;

    const response = await fetch('http://localhost:8000/measure?' + fst, { signal: AbortSignal.timeout(5000) })

    model_form.model_spec.value = model_spec;
    model_form.model_name.value = model_name;
 
    document.getElementById("model_spec").value = model_spec; 
    document.getElementById("model_name").value = model_name; 
    document.getElementById("build_dir").value = build_dir; 
    document.getElementById("draw_profile").value = draw_profile; 

    document.getElementById("results").style="display:block;"
		document.getElementById("results").height="1800px;"
    document.getElementById("results").data = build_dir + "/test/output/results.txt";

    document.getElementById("measure_btn").disabled = false;
  }
</script>


<!-- content -->
<button id="test_tab" class="collapsible">Test</button>
<div class="content">
  <form id="test_form">

    <label for="test_dir">test directory:</label>
    <input type="text" id="test_dir" name="test_dir" style="width: 400px" required><br><br>

    <button type="button" id="test_btn" onclick="test();">test</button>
  </form>

  <iframe title="plots" src="" id="plots" width=1200 height=1800 style="display:none;"></iframe>

  <p id="energy_measured"></p>
  <p id="energy_simulated"></p> 

 </div>

<!-- content -->
<button id="measure_tab" class="collapsible">Measure</button>
<div class="content">
  <form id="measure_form">
    <label for="draw_profile">draw profile:</label>
    <select name="draw_profile" id="draw_profile">
      <option selected="auto" value="auto">auto</option>
      <option value="High">High</option>
      <option value="Medium">Medium</option>
      <option value="Low">Low</option>
      <option value="Very Small">Very Small</option>
    </select><br><br>

    <button type="button" id="measure_btn" onclick="measure();">measure</button>
  </form>

  <object id="results" data="" width=800 height=1800 style="display:none;"></object>
</div>

<script>
var coll = document.getElementsByClassName("collapsible");
var i;

for (i = 0; i < coll.length; i++) {
  coll[i].addEventListener("click", function() {
    this.classList.toggle("active");
    var content = this.nextElementSibling;
    if (content.style.maxHeight){
      content.style.maxHeight = null;
    } else {
      if(this.id == "test_tab")
        content.style.maxHeight = "1020px";
      else if(this.id == "measure_tab")
        content.style.maxHeight = "320px";
    } 
  });
}
</script>

</body>

<script>
	fill_prefs()
  const test_form = document.getElementById('test_form');
  test_form.test_dir.value = "BradfordWhite/AeroThermRE2H50/RE2H50_UEF50";

  //var test_btn = document.getElementById("test_btn");

</script>

</html>